name: Security and Dependencies

on:
  schedule:
    - cron: "0 6 * * 1" # Run every Monday at 6 AM UTC
  push:
    branches: [main]
    paths:
      - "pom.xml"
      - ".github/workflows/security.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: read

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"
          cache: maven

      - name: Cache dependency check data
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository/org/owasp/dependency-check-data
            ~/.m2/repository/org/owasp/dependency-check-utils
          key: ${{ runner.os }}-dependency-check-${{ hashFiles('**/pom.xml') }}-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-dependency-check-${{ hashFiles('**/pom.xml') }}-
            ${{ runner.os }}-dependency-check-

      - name: Check if NVD API key is available
        id: check-api-key
        run: |
          if [ -z "${{ secrets.NVD_API_KEY }}" ]; then
            echo "api_key_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è NVD API Key not configured - using fast mode"
          else
            echo "api_key_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ NVD API Key configured - using full scan"
          fi

      - name: Run OWASP Dependency Check (Full scan with API key)
        if: steps.check-api-key.outputs.api_key_available == 'true'
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressValidation=true \
            -DnvdApiKey=${{ secrets.NVD_API_KEY }} \
            -DnvdMaxRetryCount=10 \
            -DnvdValidForHours=24 \
            -DretireJsAnalyzerEnabled=false \
            -DnodeAnalyzerEnabled=false \
            -DassemblyAnalyzerEnabled=false
        continue-on-error: true
        env:
          MAVEN_OPTS: "-Xmx2g -Djava.awt.headless=true"

      - name: Run OWASP Dependency Check (Fast mode without API key)
        if: steps.check-api-key.outputs.api_key_available == 'false'
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressValidation=true \
            -DskipSystemScope=true \
            -DretireJsAnalyzerEnabled=false \
            -DnodeAnalyzerEnabled=false \
            -DassemblyAnalyzerEnabled=false \
            -DautoUpdate=false \
            -Dformat=HTML \
            -DdataDirectory=~/.m2/repository/org/owasp/dependency-check-data
        continue-on-error: true
        timeout-minutes: 10
        env:
          MAVEN_OPTS: "-Xmx1g -Djava.awt.headless=true"

      - name: Alternative security check (GitHub Advisory Database)
        if: steps.check-api-key.outputs.api_key_available == 'false'
        run: |
          echo "üîç Running alternative security analysis..."

          # Check for known vulnerable packages using GitHub Advisory Database
          mvn org.sonatype.ossindex.maven:ossindex-maven-plugin:audit \
            -Daudit.failOnError=false || true

          echo "üìã Security check completed with available tools"

      - name: Upload dependency check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"
          cache: maven

      - name: Check licenses
        run: |
          mvn org.codehaus.mojo:license-maven-plugin:check-file-header \
            -Dlicense.header=LICENSE \
            -Dlicense.failOnMissingHeader=false
        continue-on-error: true

  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"
          cache: maven

      - name: Check for updates
        run: |
          mvn versions:display-dependency-updates
          mvn versions:display-plugin-updates

      - name: Generate dependency tree
        run: mvn dependency:tree > dependency-tree.txt

      - name: Upload dependency information
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: dependency-tree.txt

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Java source files
        id: check-java
        run: |
          if find src/main/java -name "*.java" 2>/dev/null | grep -q .; then
            echo "java_files_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Java source files found - running CodeQL analysis"
          else
            echo "java_files_found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No Java source files found - skipping CodeQL analysis"
          fi

      - name: Initialize CodeQL
        if: steps.check-java.outputs.java_files_found == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Set up JDK 21
        if: steps.check-java.outputs.java_files_found == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"
          cache: maven

      - name: Build for CodeQL
        if: steps.check-java.outputs.java_files_found == 'true'
        run: mvn clean compile -B

      - name: Perform CodeQL Analysis
        if: steps.check-java.outputs.java_files_found == 'true'
        uses: github/codeql-action/analyze@v3

      - name: Skip CodeQL (No Java files)
        if: steps.check-java.outputs.java_files_found == 'false'
        run: |
          echo "üìù CodeQL analysis skipped - no Java source files found yet"
          echo "This is normal for projects in the setup phase"
          echo "CodeQL will run automatically once you add Java source files"

  create-security-issue:
    name: Create Security Issues
    runs-on: ubuntu-latest
    needs: [dependency-check, codeql-analysis]
    if: always() && (needs.dependency-check.result == 'failure' || needs.codeql-analysis.result == 'failure')

    steps:
      - name: Create issue for security findings
        uses: actions/github-script@v7
        with:
          script: |
            const dependencyResult = '${{ needs.dependency-check.result }}';
            const codeqlResult = '${{ needs.codeql-analysis.result }}';
            
            let issueBody = `
            ## Security Alert

            Security vulnerabilities or issues were detected in the latest security scan.

            **Scan Results:**
            - Dependency Check: ${dependencyResult}
            - CodeQL Analysis: ${codeqlResult}

            **Action Required:**`;
            
            if (dependencyResult === 'failure') {
              issueBody += `
            1. Review the dependency vulnerability scan results in the workflow artifacts
            2. Update dependencies if vulnerabilities are found`;
            }
            
            if (codeqlResult === 'failure') {
              issueBody += `
            3. Review CodeQL findings for potential security issues in source code`;
            }
            
            issueBody += `
            4. Close this issue once all security concerns are addressed

            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîí Security vulnerabilities detected',
              body: issueBody,
              labels: ['security', 'high']
            })
